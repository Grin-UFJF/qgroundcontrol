FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# Use bash everywhere (so "source" always works)
SHELL ["/bin/bash", "-lc"]

# -----------------------------
# Base dependencies (robust, not optimized)
# -----------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    wget \
    curl \
    unzip \
    git \
    jq \
    python3 \
    python3-venv \
    python3-pip \
    locales \
    tzdata \
    build-essential \
    ninja-build \
    cmake \
    pkg-config \
    lib32stdc++6 \
    lib32z1 \
    libglib2.0-0 \
    libx11-6 \
    libxext6 \
    libxrender1 \
    libxkbcommon0 \
    libxkbcommon-x11-0 \
    libxi6 \
    libxrandr2 \
    libxfixes3 \
    libxcursor1 \
    libxinerama1 \
    libfontconfig1 \
    libfreetype6 \
    libdbus-1-3 \
 && rm -rf /var/lib/apt/lists/*

# Locale
RUN locale-gen en_US.UTF-8 && update-locale LANG=en_US.UTF-8
ENV LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8

# -----------------------------
# Copy official QGC setup files
# -----------------------------
COPY .github/build-config.json /tmp/qt/
COPY tools/setup/install-dependencies-debian.sh /tmp/qt/
COPY tools/setup/read-config.sh /tmp/qt/

RUN chmod +x /tmp/qt/*.sh && /tmp/qt/install-dependencies-debian.sh

# -----------------------------
# Read versions from build-config.json
# -----------------------------
RUN CONFIG=/tmp/qt/build-config.json && \
    echo "export QT_VERSION=$(jq -r '.qt_version' $CONFIG)" >> /etc/profile.d/qgc.sh && \
    echo "export QT_MODULES=\"$(jq -r '.qt_modules' $CONFIG)\"" >> /etc/profile.d/qgc.sh && \
    echo "export JAVA_VERSION=$(jq -r '.java_version' $CONFIG)" >> /etc/profile.d/qgc.sh && \
    echo "export NDK_FULL_VERSION=$(jq -r '.ndk_full_version' $CONFIG)" >> /etc/profile.d/qgc.sh && \
    echo "export ANDROID_PLATFORM=$(jq -r '.android_platform' $CONFIG)" >> /etc/profile.d/qgc.sh && \
    echo "export ANDROID_BUILD_TOOLS=$(jq -r '.android_build_tools' $CONFIG)" >> /etc/profile.d/qgc.sh && \
    echo "export ANDROID_CMDLINE_TOOLS=$(jq -r '.android_cmdline_tools' $CONFIG)" >> /etc/profile.d/qgc.sh && \
    chmod +x /etc/profile.d/qgc.sh

# -----------------------------
# Java
# -----------------------------
RUN source /etc/profile.d/qgc.sh && \
    apt-get update && apt-get install -y openjdk-${JAVA_VERSION}-jdk && \
    rm -rf /var/lib/apt/lists/*

RUN echo "export JAVA_HOME=/usr/lib/jvm/java-${JAVA_VERSION}-openjdk-amd64" >> /etc/profile.d/qgc.sh

# -----------------------------
# Android SDK / NDK
# -----------------------------
ENV ANDROID_SDK_ROOT=/opt/android-sdk
ENV ANDROID_HOME=/opt/android-sdk

RUN source /etc/profile.d/qgc.sh && \
    mkdir -p ${ANDROID_SDK_ROOT}/cmdline-tools && \
    wget -q https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_CMDLINE_TOOLS}_latest.zip -O /opt/cmdline-tools.zip && \
    unzip -q /opt/cmdline-tools.zip -d ${ANDROID_SDK_ROOT}/cmdline-tools && \
    mkdir -p ${ANDROID_SDK_ROOT}/cmdline-tools/latest && \
    mv ${ANDROID_SDK_ROOT}/cmdline-tools/cmdline-tools/* ${ANDROID_SDK_ROOT}/cmdline-tools/latest/ && \
    rm -rf ${ANDROID_SDK_ROOT}/cmdline-tools/cmdline-tools /opt/cmdline-tools.zip

ENV PATH=$PATH:${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${ANDROID_SDK_ROOT}/platform-tools

RUN source /etc/profile.d/qgc.sh && \
    yes | sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" --licenses >/dev/null && \
    sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" \
        "platform-tools" \
        "platforms;android-${ANDROID_PLATFORM}" \
        "build-tools;${ANDROID_BUILD_TOOLS}" && \
    if sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" "ndk;${NDK_FULL_VERSION}"; then \
        NDK_DIR="${ANDROID_SDK_ROOT}/ndk/${NDK_FULL_VERSION}"; \
    else \
        sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" "ndk;latest"; \
        NDK_DIR="$(ls -d ${ANDROID_SDK_ROOT}/ndk/* | sort -V | tail -n 1)"; \
    fi && \
    echo "export ANDROID_NDK_ROOT=${NDK_DIR}" >> /etc/profile.d/qgc.sh && \
    echo "export ANDROID_BUILD_TOOLS_DIR=${ANDROID_SDK_ROOT}/build-tools/${ANDROID_BUILD_TOOLS}" >> /etc/profile.d/qgc.sh

# -----------------------------
# Python venv for aqtinstall (PEP 668 safe)
# -----------------------------
RUN python3 -m venv /opt/venv && \
    /opt/venv/bin/pip install --upgrade pip setuptools wheel && \
    /opt/venv/bin/pip install aqtinstall

ENV PATH="/opt/venv/bin:$PATH"

# -----------------------------
# Qt
# -----------------------------
ENV QT_PATH=/opt/Qt
ENV QT_HOST=linux
ENV QT_HOST_ARCH=linux_gcc_64
ENV QT_HOST_ARCH_DIR=linux_gcc_64
ENV QT_TARGET=android
ENV QT_TARGET_ARCH_ARMV7=android_armv7
ENV QT_TARGET_ARCH_ARM64=android_arm64_v8a

RUN source /etc/profile.d/qgc.sh && \
    mkdir -p ${QT_PATH} && \
    aqt install-qt ${QT_HOST} desktop ${QT_VERSION} ${QT_HOST_ARCH} -O ${QT_PATH} -m ${QT_MODULES} && \
    aqt install-qt ${QT_HOST} ${QT_TARGET} ${QT_VERSION} ${QT_TARGET_ARCH_ARMV7} -O ${QT_PATH} -m ${QT_MODULES} --autodesktop && \
    aqt install-qt ${QT_HOST} ${QT_TARGET} ${QT_VERSION} ${QT_TARGET_ARCH_ARM64} -O ${QT_PATH} -m ${QT_MODULES} --autodesktop && \
    echo "export QT_ROOT_DIR_ARMV7=${QT_PATH}/${QT_VERSION}/${QT_TARGET_ARCH_ARMV7}" >> /etc/profile.d/qgc.sh && \
    echo "export QT_ROOT_DIR_ARM64=${QT_PATH}/${QT_VERSION}/${QT_TARGET_ARCH_ARM64}" >> /etc/profile.d/qgc.sh && \
    QT_HOST_PATH_FOUND="$(find ${QT_PATH}/${QT_VERSION} -maxdepth 1 -type d \( -name 'linux_*' -o -name 'gcc_*' -o -name 'clang_*' \) | head -n 1)" && \
    test -n "${QT_HOST_PATH_FOUND}" && \
    echo "export QT_HOST_PATH=${QT_HOST_PATH_FOUND}" >> /etc/profile.d/qgc.sh


# -----------------------------
# PATH consolidation
# -----------------------------
RUN source /etc/profile.d/qgc.sh && \
    echo 'export PATH=$JAVA_HOME/bin:$QT_HOST_PATH/bin:$QT_ROOT_DIR_ARMV7/bin:$QT_ROOT_DIR_ARM64/bin:$PATH:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_BUILD_TOOLS_DIR:$ANDROID_NDK_ROOT' >> /etc/profile.d/qgc.sh

# Git safe dir (mounted repo)
RUN git config --global --add safe.directory /project/source

# -----------------------------
# Build
# -----------------------------
WORKDIR /project/build

CMD ["bash", "-lc", "\
    source /etc/profile.d/qgc.sh && \
    mkdir -p /project/build/build && \
    cd /project/build/build && \
    qt-cmake -S /project/source -G Ninja \
        -DCMAKE_BUILD_TYPE=Release \
        -DQT_HOST_PATH=$QT_HOST_PATH \
        -DQT_ANDROID_BUILD_ALL_ABIS=OFF \
        -DQT_ANDROID_ABIS='armeabi-v7a;arm64-v8a' \
        -DANDROID_BUILD_TOOLS=$ANDROID_BUILD_TOOLS_DIR \
        -DANDROID_SDK_ROOT=$ANDROID_SDK_ROOT \
        -DQT_ANDROID_SIGN_APK=OFF \
        -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake && \
    cmake --build . --parallel \
"]
